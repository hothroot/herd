---
export const prerender = false;
import BaseLayout from '../layouts/BaseLayout.astro';
import AddressForm from '../components/letter/AddressForm';
import Draft from '../components/letter/Draft';
import Receipt from '../components/letter/Receipt.astro';
import Error from '../components/letter/Error.astro';

import { type Rep, type Letter } from '@/scripts/letter-state.js';
import { searchReps } from '@/scripts/search-reps.ts';
import letterToPdf from '@/scripts/letter-format.js';
import validateCaptcha from '@/scripts/recaptcha.js';
import { LetterStorage } from '@/scripts/letter-store.js';
import { validateEnvelope } from "@/scripts/crypto";
import { type Envelope, isAddressValid } from '@/scripts/letter-state.js';

import { USE_CAPTCHA } from "astro:env/server";
import { SHOW_CAPTCHA } from "astro:env/client";
import crypto from "crypto";

// don't validate captcha unless we're showing it to the user
const useCaptcha = SHOW_CAPTCHA && USE_CAPTCHA;

const pageTitle = "Send a Letter";

var letters: Array<Letter> =[];
var isGet = true;
var isDraft = false;
var isDone = false;
var isValidSubmission = false;

function formToString(value: FormDataEntryValue | null) {
    if (value === null) {
        return "";
    }
    if (typeof value === 'string') {
        return value;
    }
    return "";
}

var envelope : Envelope = null;

if (Astro.request.method === 'POST') {
    isGet = false;
    const formData = await Astro.request.formData();
    if (formData.has("envelope")) {
        envelope = JSON.parse(formToString(formData.get("envelope"))) as Envelope;
        var captchaToken: string | null = formToString(formData.get("captcha-data"));
        var captchaIsValid = await validateCaptcha(captchaToken);
        isValidSubmission = validateEnvelope(envelope);
        isDone = true; 
        if (!isValidSubmission) {
            console.log("letter failed due to invalid envelope signature ");
        } else if (envelope === null) {
            isValidSubmission = false;
            console.log("letter failed due to null envelope");
        } else if (useCaptcha && (captchaToken === null || captchaToken === "")) {
            isValidSubmission = false;
            console.log("letter failed due to missing captcha");
        } else if (useCaptcha && !captchaIsValid) {
            isValidSubmission = false;
            console.log("letter failed due to invalid captcha");
        } else {
            const address = envelope!.address;
            const reps = envelope!.reps;
            const message = formToString(formData.get("message"));
            const today = formToString(formData.get("today"));
            const now = new Date().getTime();
            let photoData: string | null = formToString(formData.get("headshot-data"));
            if (!photoData.startsWith("data:image/png")) {
                photoData = null;
                console.log("creating letter without photo");
            } else {
                console.log("creating letter with photo");
            }
            const store = new LetterStorage();
            const drafts = reps.map((rep: Rep) => {
                 const letterId = crypto.createHash('sha256')
                    .update(address.name)
                    .update(address.street)
                    .update(address.city)
                    .update(address.state)
                    .update(address.zipcode)
                    .update(now.toString())
                    .digest('hex')
                    .substring(0, 8)
                    .toUpperCase();
                return {
                    filename: `${rep.salutation} - ${today} - ${address.name}.pdf`,
                    data: letterToPdf(address, rep, today, letterId, message, photoData),
                    address: address,
                    today: today,
                    message: message,
                    hasPhoto: !!photoData,
                    recipient: rep,
                }
            });
            letters = await store.uploadLetters(drafts);
            console.log("letter uploaded");
        }
    } else {
        var address = { 
            name: formToString(formData.get("name")),
            street: formToString(formData.get("street")),
            city: formToString(formData.get("city")),
            state: formToString(formData.get("state")),
            zipcode: formToString(formData.get("zipcode")),
        }
        if (isAddressValid(address)) {
            envelope = await searchReps(Astro.url.origin, address);
            console.log("created letter envelope");
            isDraft = true;
        } else {
            isDone = true;
            isValidSubmission = false;
        }
    }
}
---
<BaseLayout pageTitle={pageTitle} >
    {isGet   && <AddressForm client:load /> }
    {isDraft && <Draft envelope={envelope} client:load client:only="react"/> } 
    {isDone  && isValidSubmission  && <Receipt letters={letters} /> }
    {isDone  && !isValidSubmission && <Error /> }
</BaseLayout>